<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta name="description" content="é—²ç½®å¸‚åœºï¼Œæµè§ˆå’Œå…‘æ¢å…¶ä»–ç”¨æˆ·å‘å¸ƒçš„é—²ç½®ç‰©å“ã€‚">
    <title>é—²ç½®å¸‚åœº - ç¢³ä¸­å’Œæ ¡å›­</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabaseClient.js"></script>
    <style>
        /* å¸‚åœºé¡µé¢ç‰¹æœ‰æ ·å¼ */
        .market-header {
            margin-bottom: 16px;
        }
        
        .search-box {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        .category-tabs {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 8px 0;
            margin-bottom: 16px;
        }
        
        .category-tab {
            padding: 8px 16px;
            background-color: #f0f9f0;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
        }
        
        .category-tab.active {
            background-color: var(--primary);
            color: white;
        }
        
        .market-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }
        
        .market-card {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .market-image {
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .market-info {
            padding: 12px;
        }
        
        .market-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .item-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 4px;
        }
        
        .market-publisher {
            font-size: 10px;
            color: #999;
            margin-bottom: 2px;
        }
        
        .market-time {
            font-size: 10px;
            color: #999;
        }
        
        .empty-market {
            text-align: center;
            padding: 60px 20px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin: 20px 0;
        }
        
        .empty-market-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .empty-market-text {
            font-size: 16px;
            color: var(--text-light);
            margin-bottom: 8px;
        }
        
        .empty-market-subtext {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 24px;
        }
        
        .empty-market-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            cursor: pointer;
            height: 48px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .empty-market-btn:hover {
            background-color: var(--primary-dark);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>é—²ç½®å¸‚åœº</h1>
        
        <!-- é¡¶éƒ¨æœç´¢æ¡† -->
        <div class="market-header">
            <input type="text" class="search-box" id="searchInput" placeholder="æœç´¢é—²ç½®ç‰©å“">
        </div>
        
        <!-- åˆ†ç±»ç­›é€‰ -->
        <div class="category-tabs">
            <div class="category-tab active" onclick="switchCategory('all')">å…¨éƒ¨</div>
            <div class="category-tab" onclick="switchCategory('digital')">æ•°ç </div>
            <div class="category-tab" onclick="switchCategory('clothing')">è¡£ç‰©</div>
            <div class="category-tab" onclick="switchCategory('books')">ä¹¦ç±</div>
            <div class="category-tab" onclick="switchCategory('home')">å®¶å±…</div>
            <div class="category-tab" onclick="switchCategory('recycle')">å›æ”¶</div>
            <div class="category-tab" onclick="switchCategory('other')">å…¶ä»–</div>
        </div>
        
        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loadingState" style="text-align: center; padding: 60px 20px; background-color: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="font-size: 32px; margin-bottom: 16px;">ğŸ”„</div>
            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">åŠ è½½ä¸­...</div>
            <div style="font-size: 14px; color: var(--text-light);">æ­£åœ¨è·å–é—²ç½®ç‰©å“</div>
        </div>
        
        <!-- å·²ç™»å½•çŠ¶æ€å†…å®¹ -->
        <div id="marketContent" style="display: none;">
            <!-- é—²ç½®ç‰©å“ç½‘æ ¼ -->
            <div class="market-grid" id="marketGrid">
                <!-- åŠ¨æ€ç”Ÿæˆçš„å¡ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            
            <!-- ç©ºçŠ¶æ€ -->
            <div id="emptyMarket" class="empty-market" style="display: none;">
                <div class="empty-market-icon">ğŸª</div>
                <div class="empty-market-text">æš‚æ— é—²ç½®ç‰©å“</div>
                <div class="empty-market-subtext">å¿«å»å‘å¸ƒå§ï¼</div>
                <button class="empty-market-btn" onclick="window.location.href='recycle.html'">å»å‘å¸ƒ</button>
            </div>
        </div>
        
        <!-- æœªç™»å½•çŠ¶æ€å†…å®¹ -->
        <div id="marketLoginPrompt" style="text-align: center; padding: 60px 20px; background-color: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: none;">
            <span style="font-size: 48px;">ğŸ”</span>
            <p style="font-size: 18px; margin: 20px 0;">ç™»å½•åæŸ¥çœ‹é—²ç½®å¸‚åœº</p>
            <p style="color: #666; margin-bottom: 32px;">æµè§ˆå’Œå…‘æ¢å…¶ä»–ç”¨æˆ·å‘å¸ƒçš„é—²ç½®ç‰©å“</p>
            <button style="background-color: var(--primary); color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 16px; font-weight: 500; cursor: pointer; height: 48px; min-width: 120px; transition: background-color 0.2s;" onclick="window.location.href='login.html'">ç«‹å³ç™»å½•</button>
        </div>
    </div>
    
    <!-- å•†å“è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="productModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div class="modal-body">
                <div class="modal-image" id="modalImage">ğŸ“±</div>
                <h3 class="modal-title" id="modalTitle"></h3>
                <div class="modal-price" id="modalPrice"></div>
                <div class="modal-detail" id="modalDetail"></div>
                <button class="modal-btn" onclick="purchaseProduct()">ç«‹å³è´­ä¹°</button>
            </div>
        </div>
    </div>
    
    <script src="js/auth.js"></script>
    <script src="js/script.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const loadingState = document.getElementById('loadingState');
            const marketContent = document.getElementById('marketContent');
            const marketLoginPrompt = document.getElementById('marketLoginPrompt');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loadingState.style.display = 'block';
            marketContent.style.display = 'none';
            marketLoginPrompt.style.display = 'none';
            
            // æ— è®ºæ˜¯å¦ç™»å½•ï¼Œéƒ½æ˜¾ç¤ºå•†å“åˆ—è¡¨
            marketContent.style.display = 'block';
            marketLoginPrompt.style.display = 'none';
            // åŠ è½½é—²ç½®ç‰©å“
            loadUsedItems();
        }
        
        // å…¨å±€å˜é‡
        let currentCategory = 'all';
        let currentSearch = '';
        let currentProduct = null;
        
        // åŠ è½½é—²ç½®ç‰©å“
        async function loadUsedItems() {
            const loadingState = document.getElementById('loadingState');
            const marketContent = document.getElementById('marketContent');
            
            try {
                // ä»æ•°æ®åº“è·å–é—²ç½®ç‰©å“
            const { data: usedItems, error } = await supabaseClient
                .from('used_items')
                .select('*')
                .eq('status', 'å·²é€šè¿‡');
                
                if (error) {
                    console.error('è·å–é—²ç½®ç‰©å“å¤±è´¥:', error);
                    return;
                }
                
                const marketGrid = document.getElementById('marketGrid');
                const emptyMarket = document.getElementById('emptyMarket');
                
                if (!usedItems || usedItems.length === 0) {
                    marketGrid.style.display = 'none';
                    emptyMarket.style.display = 'block';
                } else {
                    marketGrid.style.display = 'grid';
                    emptyMarket.style.display = 'none';
                    
                    // è°ƒè¯•ï¼šæŸ¥çœ‹è·å–åˆ°çš„æ•°æ®
                    console.log('ä»æ•°æ®åº“è·å–åˆ°çš„ usedItems:', usedItems);
                    
                    // æ¸…ç©ºç½‘æ ¼
                    marketGrid.innerHTML = '';
                    
                    // ç”Ÿæˆå¡ç‰‡
                    usedItems.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'market-card';
                        card.onclick = () => openModal(item);
                        card.style.cursor = 'pointer';
                        card.title = 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'
                        
                        // å¤„ç†å›¾ç‰‡æ˜¾ç¤º
                        let imageHtml = 'ğŸ“·';
                        if (item.image_url && item.image_url !== 'NULL' && item.image_url !== null) {
                            // æ£€æŸ¥æ˜¯å¦ä¸ºå®Œæ•´ URLï¼Œå¦‚æœä¸æ˜¯åˆ™æ„å»ºå®Œæ•´ URL
                            let imageSrc = item.image_url;
                            if (!imageSrc.startsWith('http')) {
                                // æ„å»ºå®Œæ•´çš„ Supabase Storage URL
                                imageSrc = `https://wywegcbfylaxjbjyhptq.supabase.co/storage/v1/object/public/item-images/${imageSrc}`;
                            }
                            imageHtml = `<img src="${imageSrc}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" onerror="this.src='https://placehold.co/600x400/e8f5e9/2e7d32?text=Eco+Product'; this.onerror=null;">`;
                        } else {
                            imageHtml = `<img src="https://placehold.co/600x400/e8f5e9/2e7d32?text=Eco+Product" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
                        }
                        
                        // æ ¼å¼åŒ–æ—¥æœŸ
                        let formattedTime = '';
                        if (item.created_at) {
                            const date = new Date(item.created_at);
                            formattedTime = date.toLocaleDateString('zh-CN');
                        }
                        
                        card.innerHTML = `
                            <div class="market-image">${imageHtml}</div>
                            <div class="market-info">
                                <div class="market-name">${item.name || 'æœªçŸ¥'}</div>
                                <div class="item-price">Â¥${item.price || 0}</div>
                                <div class="market-publisher">${item.seller || 'æœªçŸ¥'}</div>
                                ${formattedTime ? `<div class="market-time">${formattedTime}</div>` : ''}
                            </div>
                        `;
                        
                        marketGrid.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½é—²ç½®ç‰©å“å¤±è´¥:', error);
            } finally {
                // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºå†…å®¹
                loadingState.style.display = 'none';
                marketContent.style.display = 'block';
            }
        }
        
        // ç­›é€‰ç‰©å“
        async function filterItems() {
            const loadingState = document.getElementById('loadingState');
            const marketContent = document.getElementById('marketContent');
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                loadingState.style.display = 'block';
                marketContent.style.display = 'none';
                
                // ä»æ•°æ®åº“è·å–é—²ç½®ç‰©å“
                let { data: usedItems, error } = await supabaseClient
                    .from('used_items')
                    .select('*')
                    .eq('status', 'å·²é€šè¿‡');
                
                if (error) {
                    console.error('è·å–é—²ç½®ç‰©å“å¤±è´¥:', error);
                    return;
                }
                
                const marketGrid = document.getElementById('marketGrid');
                const emptyMarket = document.getElementById('emptyMarket');
                
                // æ ¹æ®åˆ†ç±»å’Œæœç´¢ç­›é€‰ç‰©å“
                let filteredItems = usedItems || [];
                
                // åˆ†ç±»ç­›é€‰
                if (currentCategory !== 'all') {
                    // æ˜ å°„åˆ†ç±»å€¼åˆ°ä¸­æ–‡ç±»åˆ«åç§°
                    let categoryName = '';
                    switch(currentCategory) {
                        case 'digital':
                            categoryName = 'æ•°ç ';
                            break;
                        case 'clothing':
                            categoryName = 'è¡£ç‰©';
                            break;
                        case 'books':
                            categoryName = 'ä¹¦ç±';
                            break;
                        case 'home':
                            categoryName = 'å®¶å±…';
                            break;
                        case 'recycle':
                            categoryName = 'å›æ”¶';
                            break;
                        default:
                            categoryName = 'å…¶ä»–';
                    }
                    filteredItems = filteredItems.filter(item => item.category === categoryName);
                }
                
                // æœç´¢ç­›é€‰
                if (currentSearch) {
                    const searchLower = currentSearch.toLowerCase();
                    filteredItems = filteredItems.filter(item => 
                        item.name.toLowerCase().includes(searchLower)
                    );
                }
                
                // é‡æ–°æ¸²æŸ“ç‰©å“
                if (filteredItems.length === 0) {
                    marketGrid.style.display = 'none';
                    emptyMarket.style.display = 'block';
                    // ä¿®æ”¹ç©ºçŠ¶æ€æ–‡æœ¬
                    document.querySelector('.empty-market-text').textContent = currentSearch ? 'æœªæ‰¾åˆ°ç›¸å…³é—²ç½®' : 'æš‚æ— é—²ç½®ç‰©å“';
                } else {
                    marketGrid.style.display = 'grid';
                    emptyMarket.style.display = 'none';
                    
                    // æ¸…ç©ºç½‘æ ¼
                    marketGrid.innerHTML = '';
                    
                    // ç”Ÿæˆå¡ç‰‡
                    filteredItems.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'market-card';
                        card.onclick = () => openModal(item);
                        
                        // å¤„ç†å›¾ç‰‡æ˜¾ç¤º
                        let imageHtml = 'ğŸ“·';
                        if (item.image_url && item.image_url !== 'NULL' && item.image_url !== null) {
                            // æ£€æŸ¥æ˜¯å¦ä¸ºå®Œæ•´ URLï¼Œå¦‚æœä¸æ˜¯åˆ™æ„å»ºå®Œæ•´ URL
                            let imageSrc = item.image_url;
                            if (!imageSrc.startsWith('http')) {
                                // æ„å»ºå®Œæ•´çš„ Supabase Storage URL
                                imageSrc = `https://wywegcbfylaxjbjyhptq.supabase.co/storage/v1/object/public/item-images/${imageSrc}`;
                            }
                            imageHtml = `<img src="${imageSrc}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" onerror="this.src='https://placehold.co/600x400/e8f5e9/2e7d32?text=Eco+Product'; this.onerror=null;">`;
                        } else {
                            imageHtml = `<img src="https://placehold.co/600x400/e8f5e9/2e7d32?text=Eco+Product" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
                        }
                        
                        // æ ¼å¼åŒ–æ—¥æœŸ
                        let formattedTime = '';
                        if (item.created_at) {
                            const date = new Date(item.created_at);
                            formattedTime = date.toLocaleDateString('zh-CN');
                        }
                        
                        card.innerHTML = `
                            <div class="market-image">${imageHtml}</div>
                            <div class="market-info">
                                <div class="market-name">${item.name || 'æœªçŸ¥'}</div>
                                <div class="item-price">Â¥${item.price || 0}</div>
                                <div class="market-publisher">${item.seller || 'æœªçŸ¥'}</div>
                                ${formattedTime ? `<div class="market-time">${formattedTime}</div>` : ''}
                            </div>
                        `;
                        
                        marketGrid.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('ç­›é€‰ç‰©å“å¤±è´¥:', error);
            } finally {
                // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºå†…å®¹
                loadingState.style.display = 'none';
                marketContent.style.display = 'block';
            }
        }
        
        // åˆ‡æ¢åˆ†ç±»
        function switchCategory(category) {
            // åˆ‡æ¢æ¿€æ´»çŠ¶æ€
            const tabs = document.querySelectorAll('.category-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // æ›´æ–°å½“å‰åˆ†ç±»å¹¶ç­›é€‰
            currentCategory = category;
            filterItems();
        }
        
        // ç»‘å®šæœç´¢äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    currentSearch = this.value;
                    filterItems();
                });
            }
        });
        
        // æ‰“å¼€å•†å“è¯¦æƒ…æ¨¡æ€æ¡†
        function openModal(item) {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•åå†æŸ¥çœ‹å•†å“è¯¦æƒ…');
                return;
            }
            
            currentProduct = item;
            
            // å¤„ç†å›¾ç‰‡æ˜¾ç¤º
            const modalImage = document.getElementById('modalImage');
            if (item.image_url && item.image_url !== 'NULL' && item.image_url !== null) {
                // æ£€æŸ¥æ˜¯å¦ä¸ºå®Œæ•´ URLï¼Œå¦‚æœä¸æ˜¯åˆ™æ„å»ºå®Œæ•´ URL
                let imageSrc = item.image_url;
                if (!imageSrc.startsWith('http')) {
                    // æ„å»ºå®Œæ•´çš„ Supabase Storage URL
                    imageSrc = `https://wywegcbfylaxjbjyhptq.supabase.co/storage/v1/object/public/item-images/${imageSrc}`;
                }
                modalImage.innerHTML = `<img src="${imageSrc}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;" onerror="this.src='https://placehold.co/600x400/e8f5e9/2e7d32?text=Eco+Product'; this.onerror=null;">`;
            } else {
                modalImage.innerHTML = `<img src="https://placehold.co/600x400/e8f5e9/2e7d32?text=Eco+Product" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;">`;
            }
            
            document.getElementById('modalTitle').textContent = item.name || 'æœªçŸ¥';
            document.getElementById('modalPrice').textContent = 'Â¥' + (item.price || 0);
            
            // æ„å»ºè¯¦æƒ…å†…å®¹
            let detailContent = '';
            if (item.category) {
                // ç±»åˆ«ä¸­è‹±æ–‡è½¬æ¢
                let categoryName = item.category;
                switch(categoryName) {
                    case 'digital':
                        categoryName = 'æ•°ç ';
                        break;
                    case 'clothing':
                        categoryName = 'è¡£ç‰©';
                        break;
                    case 'books':
                        categoryName = 'ä¹¦ç±';
                        break;
                    case 'home':
                        categoryName = 'å®¶å±…';
                        break;
                    case 'recycle':
                        categoryName = 'å›æ”¶';
                        break;
                    case 'other':
                        categoryName = 'å…¶ä»–';
                        break;
                }
                detailContent += `<p>ç±»åˆ«ï¼š${categoryName}</p>`;
            }
            if (item.condition) {
                detailContent += `<p>æè¿°ï¼š${item.condition}</p>`;
            }
            if (item.seller) {
                detailContent += `<p>å‘å¸ƒè€…ï¼š${item.seller}</p>`;
            }
            if (item.created_at) {
                const date = new Date(item.created_at);
                const formattedTime = date.toLocaleDateString('zh-CN');
                detailContent += `<p>å‘å¸ƒæ—¶é—´ï¼š${formattedTime}</p>`;
            }
            
            document.getElementById('modalDetail').innerHTML = detailContent;
            document.getElementById('productModal').style.display = 'flex';
        }
        
        // è·å–ç±»åˆ«å›¾æ ‡
        function getCategoryIcon(category) {
            switch(category) {
                case 'æ•°ç ':
                    return 'ğŸ“±';
                case 'è¡£ç‰©':
                    return 'ğŸ‘•';
                case 'ä¹¦ç±':
                    return 'ğŸ“š';
                case 'å®¶å±…':
                    return 'ğŸ ';
                case 'å›æ”¶':
                    return 'â™»ï¸';
                default:
                    return 'ğŸ“¦';
            }
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
        }
        
        // ç›´æ¥è´­ä¹°å•†å“ï¼ˆç‚¹å‡»å¡ç‰‡ç›´æ¥è´­ä¹°ï¼‰
        async function purchaseProductDirect(item) {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•åå†è´­ä¹°å•†å“');
                return;
            }
            
            try {
                // åˆ¤æ–­å•†å“æ˜¯å¦å·²å”®
                const { data: checkData, error: checkError } = await supabaseClient
                    .from('used_items')
                    .select('id')
                    .eq('id', item.id)
                    .single();
                
                if (checkError || !checkData) {
                    throw new Error('å•†å“ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤');
                }
                
                // ç»™è´­ä¹°è€…å¢åŠ ç§¯åˆ†å¥–åŠ±
                const username = localStorage.getItem('currentUsername');
                
                // è·å–ç”¨æˆ·ID
                const { data: profileData, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('id')
                    .eq('username', username)
                    .single();
                
                if (profileError) {
                    console.error('è·å–ç”¨æˆ·IDå¤±è´¥:', profileError);
                    throw new Error('è·å–ç”¨æˆ·IDå¤±è´¥');
                }
                
                // ä½¿ç”¨ parseInt() æ˜¾å¼å°† profileData.id è½¬æ¢ä¸ºæ•´æ•°ç±»å‹
                const userId = parseInt(profileData?.id);
                
                // ä½¿ç”¨ RPC è°ƒç”¨ handle_add_points å¢åŠ ç§¯åˆ†
                const { error: rpcError } = await supabaseClient.rpc('handle_add_points', { 
                    user_id: userId, 
                    amount: 5 
                });
                
                if (rpcError) {
                    console.error('RPC è°ƒç”¨å¤±è´¥:', rpcError);
                    throw new Error('ç§¯åˆ†æ›´æ–°å¤±è´¥');
                }
                
                // æ›´æ–° localStorage ä¸­çš„ userPoints
                const { data: newProfileData } = await supabaseClient
                    .from('profiles')
                    .select('points')
                    .eq('username', username)
                    .single();
                
                if (newProfileData) {
                    localStorage.setItem('userPoints', newProfileData.points);
                    console.log('ç§¯åˆ†æ›´æ–°æˆåŠŸï¼Œå½“å‰ç§¯åˆ†:', newProfileData.points);
                }
                
                // ä»æ•°æ®åº“ä¸­åˆ é™¤è¯¥å•†å“
                const { error: deleteError } = await supabaseClient
                    .from('used_items')
                    .delete()
                    .eq('id', item.id);
                
                if (deleteError) {
                    console.error('åˆ é™¤å•†å“å¤±è´¥:', deleteError);
                    throw new Error('åˆ é™¤å•†å“å¤±è´¥');
                }
                
                // åˆ·æ–°å¸‚åœºåˆ—è¡¨
                await loadUsedItems();
                
                alert('æ„Ÿè°¢å‚ä¸ç»¿è‰²å¾ªç¯ï¼Œè·å¾— 5 ç»¿åˆ†å¥–åŠ±ï¼');
            } catch (error) {
                console.error('è´­ä¹°å•†å“å¤±è´¥:', error);
                alert(error.message || 'è´­ä¹°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // è´­ä¹°å•†å“
        async function purchaseProduct() {
            if (!currentProduct) return;
            
            // äºŒæ¬¡ç¡®è®¤ï¼šè¯¢é—®ç”¨æˆ·æ˜¯å¦ç¡®å®šè´­ä¹°
            if (!confirm(`ç¡®å®šè¦è´­ä¹°ã€Œ${currentProduct.name}ã€å—ï¼Ÿ\n\nä»·æ ¼ï¼šÂ¥${currentProduct.price}\nè´­ä¹°åå°†è·å¾— 5 ç»¿åˆ†å¥–åŠ±`)) {
                return; // ç”¨æˆ·å–æ¶ˆè´­ä¹°
            }
            
            const purchaseBtn = document.querySelector('.modal-btn');
            const originalText = purchaseBtn.textContent;
            purchaseBtn.textContent = 'è´­ä¹°ä¸­...';
            purchaseBtn.disabled = true;
            purchaseBtn.classList.add('btn-loading');
            
            try {
                // åˆ¤æ–­å•†å“æ˜¯å¦å·²å”®
                const { data: checkData, error: checkError } = await supabaseClient
                    .from('used_items')
                    .select('id')
                    .eq('id', currentProduct.id)
                    .single();
                
                if (checkError || !checkData) {
                    throw new Error('å•†å“ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤');
                }
                
                // ç»™è´­ä¹°è€…å¢åŠ ç§¯åˆ†å¥–åŠ±
                const username = localStorage.getItem('currentUsername');
                
                // è·å–ç”¨æˆ·ID
                const { data: profileData, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('id')
                    .eq('username', username)
                    .single();
                
                if (profileError) {
                    console.error('è·å–ç”¨æˆ·IDå¤±è´¥:', profileError);
                    throw new Error('è·å–ç”¨æˆ·IDå¤±è´¥');
                }
                
                // ä½¿ç”¨ parseInt() æ˜¾å¼å°† profileData.id è½¬æ¢ä¸ºæ•´æ•°ç±»å‹
                const userId = parseInt(profileData?.id);
                
                // ä½¿ç”¨ RPC è°ƒç”¨ handle_add_points å¢åŠ ç§¯åˆ†
                const { error: rpcError } = await supabaseClient.rpc('handle_add_points', { 
                    user_id: userId, 
                    amount: 5 
                });
                
                if (rpcError) {
                    console.error('RPC è°ƒç”¨å¤±è´¥:', rpcError);
                    throw new Error('ç§¯åˆ†æ›´æ–°å¤±è´¥');
                }
                
                // æ›´æ–° localStorage ä¸­çš„ userPoints
                const { data: newProfileData } = await supabaseClient
                    .from('profiles')
                    .select('points')
                    .eq('username', username)
                    .single();
                
                if (newProfileData) {
                    localStorage.setItem('userPoints', newProfileData.points);
                    console.log('ç§¯åˆ†æ›´æ–°æˆåŠŸï¼Œå½“å‰ç§¯åˆ†:', newProfileData.points);
                }
                
                // ä»æ•°æ®åº“ä¸­åˆ é™¤è¯¥å•†å“
                const { error: deleteError } = await supabaseClient
                    .from('used_items')
                    .delete()
                    .eq('id', currentProduct.id);
                
                if (deleteError) {
                    console.error('åˆ é™¤å•†å“å¤±è´¥:', deleteError);
                    throw new Error('åˆ é™¤å•†å“å¤±è´¥');
                }
                
                // åˆ·æ–°å¸‚åœºåˆ—è¡¨
                await loadUsedItems();
                
                alert('æ„Ÿè°¢å‚ä¸ç»¿è‰²å¾ªç¯ï¼Œè·å¾— 5 ç»¿åˆ†å¥–åŠ±ï¼');
            } catch (error) {
                console.error('è´­ä¹°å•†å“å¤±è´¥:', error);
                alert(error.message || 'è´­ä¹°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                closeModal();
                purchaseBtn.textContent = originalText;
                purchaseBtn.disabled = false;
                purchaseBtn.classList.remove('btn-loading');
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('productModal');
            if (event.target == modal) {
                closeModal();
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = function() {
            checkLoginStatus();
        };
    </script>
    <script src="js/footer.js"></script>
</body>
</html>