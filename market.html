<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta name="description" content="é—²ç½®å¸‚åœºï¼Œæµè§ˆå’Œå…‘æ¢å…¶ä»–ç”¨æˆ·å‘å¸ƒçš„é—²ç½®ç‰©å“ã€‚">
    <title>é—²ç½®å¸‚åœº - ç¢³ä¸­å’Œæ ¡å›­</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabaseClient.js"></script>
    <style>
        /* å¸‚åœºé¡µé¢ç‰¹æœ‰æ ·å¼ */
        .market-header {
            margin-bottom: 16px;
        }
        
        .search-box {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        .category-tabs {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 8px 0;
            margin-bottom: 16px;
        }
        
        .category-tab {
            padding: 8px 16px;
            background-color: #f0f9f0;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
        }
        
        .category-tab.active {
            background-color: var(--primary);
            color: white;
        }
        
        .market-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }
        
        .market-card {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .market-image {
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .market-info {
            padding: 12px;
        }
        
        .market-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .item-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 4px;
        }
        
        .market-publisher {
            font-size: 10px;
            color: #999;
            margin-bottom: 2px;
        }
        
        .market-time {
            font-size: 10px;
            color: #999;
        }
        
        .empty-market {
            text-align: center;
            padding: 60px 20px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin: 20px 0;
        }
        
        .empty-market-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .empty-market-text {
            font-size: 16px;
            color: var(--text-light);
            margin-bottom: 8px;
        }
        
        .empty-market-subtext {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 24px;
        }
        
        .empty-market-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            cursor: pointer;
            height: 48px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .empty-market-btn:hover {
            background-color: var(--primary-dark);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>é—²ç½®å¸‚åœº</h1>
        
        <!-- é¡¶éƒ¨æœç´¢æ¡† -->
        <div class="market-header">
            <input type="text" class="search-box" id="searchInput" placeholder="æœç´¢é—²ç½®ç‰©å“">
        </div>
        
        <!-- åˆ†ç±»ç­›é€‰ -->
        <div class="category-tabs">
            <div class="category-tab active" onclick="switchCategory('all')">å…¨éƒ¨</div>
            <div class="category-tab" onclick="switchCategory('digital')">æ•°ç </div>
            <div class="category-tab" onclick="switchCategory('clothing')">è¡£ç‰©</div>
            <div class="category-tab" onclick="switchCategory('books')">ä¹¦ç±</div>
            <div class="category-tab" onclick="switchCategory('home')">å®¶å±…</div>
            <div class="category-tab" onclick="switchCategory('recycle')">å›æ”¶</div>
            <div class="category-tab" onclick="switchCategory('other')">å…¶ä»–</div>
        </div>
        
        <!-- å·²ç™»å½•çŠ¶æ€å†…å®¹ -->
        <div id="marketContent" style="display: none;">
            <!-- é—²ç½®ç‰©å“ç½‘æ ¼ -->
            <div class="market-grid" id="marketGrid">
                <!-- åŠ¨æ€ç”Ÿæˆçš„å¡ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            
            <!-- ç©ºçŠ¶æ€ -->
            <div id="emptyMarket" class="empty-market" style="display: none;">
                <div class="empty-market-icon">ğŸª</div>
                <div class="empty-market-text">æš‚æ— é—²ç½®ç‰©å“</div>
                <div class="empty-market-subtext">å¿«å»å‘å¸ƒå§ï¼</div>
                <button class="empty-market-btn" onclick="window.location.href='recycle.html'">å»å‘å¸ƒ</button>
            </div>
        </div>
        
        <!-- æœªç™»å½•çŠ¶æ€å†…å®¹ -->
        <div id="marketLoginPrompt" style="text-align: center; padding: 60px 20px; background-color: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <span style="font-size: 48px;">ğŸ”</span>
            <p style="font-size: 18px; margin: 20px 0;">ç™»å½•åæŸ¥çœ‹é—²ç½®å¸‚åœº</p>
            <p style="color: #666; margin-bottom: 32px;">æµè§ˆå’Œå…‘æ¢å…¶ä»–ç”¨æˆ·å‘å¸ƒçš„é—²ç½®ç‰©å“</p>
            <button style="background-color: var(--primary); color: white; border: none; border-radius: 8px; padding: 12px 32px; font-size: 16px; font-weight: 500; cursor: pointer; height: 48px; min-width: 120px; transition: background-color 0.2s;" onclick="window.location.href='login.html'">ç«‹å³ç™»å½•</button>
        </div>
    </div>
    
    <!-- å•†å“è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="productModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div class="modal-body">
                <div class="modal-image" id="modalImage">ğŸ“±</div>
                <h3 class="modal-title" id="modalTitle"></h3>
                <div class="modal-price" id="modalPrice"></div>
                <div class="modal-detail" id="modalDetail"></div>
                <button class="modal-btn" onclick="purchaseProduct()">ç«‹å³è´­ä¹°</button>
            </div>
        </div>
    </div>
    
    <script src="js/auth.js"></script>
    <script src="js/script.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const marketContent = document.getElementById('marketContent');
            const marketLoginPrompt = document.getElementById('marketLoginPrompt');
            
            // æ— è®ºæ˜¯å¦ç™»å½•ï¼Œéƒ½æ˜¾ç¤ºå•†å“åˆ—è¡¨
            marketContent.style.display = 'block';
            marketLoginPrompt.style.display = 'none';
            // åŠ è½½é—²ç½®ç‰©å“
            loadUsedItems();
        }
        
        // å…¨å±€å˜é‡
        let currentCategory = 'all';
        let currentSearch = '';
        let currentProduct = null;
        
        // åŠ è½½é—²ç½®ç‰©å“
        async function loadUsedItems() {
            try {
                // ä»æ•°æ®åº“è·å–é—²ç½®ç‰©å“
                const { data: usedItems, error } = await supabase
                    .from('used_items')
                    .select('*');
                
                if (error) {
                    console.error('è·å–é—²ç½®ç‰©å“å¤±è´¥:', error);
                    return;
                }
                
                const marketGrid = document.getElementById('marketGrid');
                const emptyMarket = document.getElementById('emptyMarket');
                
                if (!usedItems || usedItems.length === 0) {
                    marketGrid.style.display = 'none';
                    emptyMarket.style.display = 'block';
                } else {
                    marketGrid.style.display = 'grid';
                    emptyMarket.style.display = 'none';
                    
                    // æ¸…ç©ºç½‘æ ¼
                    marketGrid.innerHTML = '';
                    
                    // ç”Ÿæˆå¡ç‰‡
                    usedItems.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'market-card';
                        card.onclick = () => openModal(item);
                        
                        card.innerHTML = `
                            <div class="market-image">${item.image || 'ğŸ“·'}</div>
                            <div class="market-info">
                                <div class="market-name">${item.name}</div>
                                <div class="item-price">Â¥${item.price || 0}</div>
                                <div class="market-publisher">${item.publisher}</div>
                                <div class="market-time">${item.time}</div>
                            </div>
                        `;
                        
                        marketGrid.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½é—²ç½®ç‰©å“å¤±è´¥:', error);
            }
        }
        
        // ç­›é€‰ç‰©å“
        async function filterItems() {
            try {
                // ä»æ•°æ®åº“è·å–é—²ç½®ç‰©å“
                let { data: usedItems, error } = await supabase
                    .from('used_items')
                    .select('*');
                
                if (error) {
                    console.error('è·å–é—²ç½®ç‰©å“å¤±è´¥:', error);
                    return;
                }
                
                const marketGrid = document.getElementById('marketGrid');
                const emptyMarket = document.getElementById('emptyMarket');
                
                // æ ¹æ®åˆ†ç±»å’Œæœç´¢ç­›é€‰ç‰©å“
                let filteredItems = usedItems || [];
                
                // åˆ†ç±»ç­›é€‰
                if (currentCategory !== 'all') {
                    // æ˜ å°„åˆ†ç±»å€¼åˆ°ä¸­æ–‡ç±»åˆ«åç§°
                    let categoryName = '';
                    switch(currentCategory) {
                        case 'digital':
                            categoryName = 'æ•°ç ';
                            break;
                        case 'clothing':
                            categoryName = 'è¡£ç‰©';
                            break;
                        case 'books':
                            categoryName = 'ä¹¦ç±';
                            break;
                        case 'home':
                            categoryName = 'å®¶å±…';
                            break;
                        case 'recycle':
                            categoryName = 'å›æ”¶';
                            break;
                        default:
                            categoryName = 'å…¶ä»–';
                    }
                    filteredItems = filteredItems.filter(item => item.category === categoryName);
                }
                
                // æœç´¢ç­›é€‰
                if (currentSearch) {
                    const searchLower = currentSearch.toLowerCase();
                    filteredItems = filteredItems.filter(item => 
                        item.name.toLowerCase().includes(searchLower)
                    );
                }
                
                // é‡æ–°æ¸²æŸ“ç‰©å“
                if (filteredItems.length === 0) {
                    marketGrid.style.display = 'none';
                    emptyMarket.style.display = 'block';
                    // ä¿®æ”¹ç©ºçŠ¶æ€æ–‡æœ¬
                    document.querySelector('.empty-market-text').textContent = currentSearch ? 'æœªæ‰¾åˆ°ç›¸å…³é—²ç½®' : 'æš‚æ— é—²ç½®ç‰©å“';
                } else {
                    marketGrid.style.display = 'grid';
                    emptyMarket.style.display = 'none';
                    
                    // æ¸…ç©ºç½‘æ ¼
                    marketGrid.innerHTML = '';
                    
                    // ç”Ÿæˆå¡ç‰‡
                    filteredItems.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'market-card';
                        card.onclick = () => openModal(item);
                        
                        card.innerHTML = `
                            <div class="market-image">${item.image || 'ğŸ“·'}</div>
                            <div class="market-info">
                                <div class="market-name">${item.name}</div>
                                <div class="item-price">Â¥${item.price || 0}</div>
                                <div class="market-publisher">${item.publisher}</div>
                                <div class="market-time">${item.time}</div>
                            </div>
                        `;
                        
                        marketGrid.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('ç­›é€‰ç‰©å“å¤±è´¥:', error);
            }
        }
        
        // åˆ‡æ¢åˆ†ç±»
        function switchCategory(category) {
            // åˆ‡æ¢æ¿€æ´»çŠ¶æ€
            const tabs = document.querySelectorAll('.category-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // æ›´æ–°å½“å‰åˆ†ç±»å¹¶ç­›é€‰
            currentCategory = category;
            filterItems();
        }
        
        // ç»‘å®šæœç´¢äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    currentSearch = this.value;
                    filterItems();
                });
            }
        });
        
        // æ‰“å¼€å•†å“è¯¦æƒ…æ¨¡æ€æ¡†
        function openModal(item) {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•åå†æŸ¥çœ‹å•†å“è¯¦æƒ…');
                return;
            }
            
            currentProduct = item;
            document.getElementById('modalImage').textContent = getCategoryIcon(item.category);
            document.getElementById('modalTitle').textContent = item.name;
            document.getElementById('modalPrice').textContent = 'Â¥' + (item.price || 0);
            document.getElementById('modalDetail').innerHTML = `
                <p>ç±»åˆ«ï¼š${item.category}</p>
                <p>æ–°æ—§ç¨‹åº¦ï¼š${item.condition}</p>
                <p>å‘å¸ƒè€…ï¼š${item.publisher}</p>
                <p>å‘å¸ƒæ—¶é—´ï¼š${item.time}</p>
            `;
            document.getElementById('productModal').style.display = 'flex';
        }
        
        // è·å–ç±»åˆ«å›¾æ ‡
        function getCategoryIcon(category) {
            switch(category) {
                case 'æ•°ç ':
                    return 'ğŸ“±';
                case 'è¡£ç‰©':
                    return 'ğŸ‘•';
                case 'ä¹¦ç±':
                    return 'ğŸ“š';
                case 'å®¶å±…':
                    return 'ğŸ ';
                case 'å›æ”¶':
                    return 'â™»ï¸';
                default:
                    return 'ğŸ“¦';
            }
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
        }
        
        // è´­ä¹°å•†å“
        async function purchaseProduct() {
            if (!currentProduct) return;
            
            const purchaseBtn = document.querySelector('.modal-btn');
            const originalText = purchaseBtn.textContent;
            purchaseBtn.textContent = 'è´­ä¹°ä¸­...';
            purchaseBtn.disabled = true;
            purchaseBtn.classList.add('btn-loading');
            
            try {
                // ç¡®è®¤è´­ä¹°
                if (confirm(`ç¡®è®¤èŠ±è´¹ Â¥${currentProduct.price || 0} è´­ä¹°æ­¤å•†å“ï¼Ÿ`)) {
                    // ç»™è´­ä¹°è€…å¢åŠ ç§¯åˆ†å¥–åŠ±
                    const username = localStorage.getItem('username') || 'æ—å°ç»¿';
                    const pointsToAdd = 5;
                    
                    // æ›´æ–°ç”¨æˆ·ç§¯åˆ†
                    const { error: pointsError } = await supabase
                        .from('profiles')
                        .update({ points: supabase.raw(`points + ${pointsToAdd}`) })
                        .eq('username', username);
                    
                    if (pointsError) {
                        throw pointsError;
                    }
                    
                    // ä»æ•°æ®åº“ä¸­åˆ é™¤è¯¥å•†å“
                    const { error: deleteError } = await supabase
                        .from('used_items')
                        .delete()
                        .eq('id', currentProduct.id);
                    
                    if (deleteError) {
                        throw deleteError;
                    }
                    
                    // åˆ·æ–°å¸‚åœºåˆ—è¡¨
                    await loadUsedItems();
                    
                    alert('è´­ä¹°æˆåŠŸï¼è·å¾—5ç§¯åˆ†');
                }
            } catch (error) {
                console.error('è´­ä¹°å•†å“å¤±è´¥:', error);
                alert('è´­ä¹°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                closeModal();
                purchaseBtn.textContent = originalText;
                purchaseBtn.disabled = false;
                purchaseBtn.classList.remove('btn-loading');
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('productModal');
            if (event.target == modal) {
                closeModal();
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = function() {
            checkLoginStatus();
        };
    </script>
    <script src="js/footer.js"></script>
</body>
</html>