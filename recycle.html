<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta name="description" content="å‘å¸ƒç»¿è‰²é—²ç½®ï¼Œä¸ºåœ°çƒå‡ç¢³ï¼Œè·å¾—ç»¿åˆ†å¥–åŠ±ã€‚">
    <title>å‘å¸ƒé—²ç½® - ç¢³ä¸­å’Œæ ¡å›­</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabaseClient.js"></script>
    <style>
        .photo-upload {
            margin-bottom: 24px;
        }
        
        .photo-preview {
            background: linear-gradient(135deg, rgba(240, 253, 244, 0.9), rgba(220, 252, 231, 0.9));
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 3px dashed #4caf50;
            border-radius: 20px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.1);
        }
        
        .photo-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.1), transparent);
            transition: left 0.6s ease;
        }
        
        .photo-preview:hover::before {
            left: 100%;
        }
        
        .photo-preview.dragover {
            border-color: #2e7d32;
            background: linear-gradient(135deg, rgba(220, 252, 231, 0.95), rgba(187, 247, 208, 0.95));
            box-shadow: 0 8px 32px rgba(76, 175, 80, 0.3);
            transform: translateY(-2px);
        }
        
        .photo-preview.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 4px solid rgba(76, 175, 80, 0.2);
            border-top: 4px solid #4caf50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .photo-preview:hover {
            border-color: #2e7d32;
            box-shadow: 0 8px 32px rgba(76, 175, 80, 0.25);
            transform: translateY(-4px);
        }
        
        .preview-content {
            position: relative;
            z-index: 1;
        }
        
        .image-container {
            position: relative;
            display: inline-block;
        }
        
        .upload-icon {
            color: #4caf50;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .photo-preview:hover .upload-icon {
            transform: scale(1.1);
        }
        
        .photo-preview.has-image {
            border-style: solid;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(240, 253, 244, 0.9));
        }
        
        .photo-preview.has-image .image-container {
            position: relative;
            display: inline-block;
        }
        
        .photo-preview.has-image img {
            max-width: 100%;
            max-height: 320px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }
        
        .photo-preview.has-image:hover img {
            transform: scale(1.02);
        }
        
        .delete-btn {
            position: absolute;
            top: -12px;
            right: -12px;
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .delete-btn:hover {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(244, 67, 54, 0.5);
        }
        
        .delete-btn:active {
            transform: scale(0.95);
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
            min-height: 52px;
            width: 100%;
            max-width: 240px;
            letter-spacing: 0.02em;
        }
        
        .upload-btn:hover {
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(76, 175, 80, 0.4);
        }
        
        .upload-btn:active {
            transform: translateY(-1px) scale(0.98);
        }
        
        @keyframes float {
            0% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-15px);
            }
            100% {
                transform: translateY(0px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="font-size: 28px; font-weight: 700; color: var(--text-dark); margin-bottom: 20px; text-align: center; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); letter-spacing: -0.02em;">å‘å¸ƒç»¿è‰²é—²ç½®</h1>
        
        <!-- é¡µé¢å‰¯æ ‡é¢˜ -->
        <div class="card" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); margin-bottom: 32px; padding: 24px; text-align: center; border: 1px solid #bbf7d0; box-shadow: 0 4px 20px rgba(76, 175, 80, 0.15);">
            <h3 style="font-size: 20px; font-weight: 600; color: var(--text-dark); margin-bottom: 12px;">ä¸Šä¼ ä½ çš„é—²ç½®ï¼ŒåŠ©åŠ›ç¢³å‡æ’</h3>
            <p style="color: #64748b; font-size: 16px; margin-top: 0; line-height: 1.5;">ä½ çš„æ¯ä¸€æ¬¡å›æ”¶éƒ½åœ¨å®ˆæŠ¤åœ°çƒï¼Œä¸ºå¯æŒç»­å‘å±•è´¡çŒ®åŠ›é‡ã€‚</p>
        </div>
        
        <!-- å·²ç™»å½•çŠ¶æ€å†…å®¹ -->
        <div id="publishForm" style="display: none;">
            <!-- æ·»åŠ ç…§ç‰‡åŒºåŸŸ -->
            <div class="photo-upload">
                <div id="photoPreview" class="photo-preview">
                    <div class="preview-content">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="upload-icon"><path d="M16 16v1a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-1"></path><path d="M8 16s-4-4-4-8a4 4 0 0 1 8 0c0 4-4 8-4 8"></path><path d="M12 12v6"></path><path d="m15 15-3-3-3 3"></path></svg>
                        <h3>æ·»åŠ ç…§ç‰‡</h3>
                        <p style="color: #666; font-size: 14px; margin: 8px 0 16px;">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡è‡³æ­¤</p>
                        <p style="color: #999; font-size: 12px; margin-bottom: 24px;">ä¸Šä¼ ä¸€å¼ æ¸…æ™°çš„ç‰©å“ç…§ç‰‡</p>
                        <button class="upload-btn" onclick="event.stopPropagation(); document.getElementById('imageUpload').click()">é€‰æ‹©å›¾ç‰‡</button>
                    </div>
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                    <span id="fileName">æœªé€‰æ‹©æ–‡ä»¶</span>
                </div>
            </div>
            
            <!-- è¡¨å• -->
            <div class="card" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9)); padding: 24px;">
                <h3 style="margin-bottom: 16px; color: var(--text-dark); font-size: 18px; font-weight: 600;">ç‰©å“åç§°</h3>
                <input type="text" id="itemName" placeholder="ä¾‹å¦‚ï¼šä¸­å¤ç»ç’ƒç“¶" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; font-size: 16px; margin-bottom: 20px; transition: all 0.3s ease;">
                
                <h3 style="margin-bottom: 16px; color: var(--text-dark); font-size: 18px; font-weight: 600;">ç±»åˆ«é€‰æ‹©</h3>
                <select id="itemCategory" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; font-size: 16px; margin-bottom: 20px; transition: all 0.3s ease;">
                    <option value="">é€‰æ‹©ç±»åˆ«</option>
                    <option value="digital">æ•°ç </option>
                    <option value="clothing">è¡£ç‰©</option>
                    <option value="books">ä¹¦ç±</option>
                    <option value="other">å…¶ä»–</option>
                </select>
                
                <h3 style="margin-bottom: 16px; color: var(--text-dark); font-size: 18px; font-weight: 600;">äº§å“çŠ¶å†µ</h3>
                <input type="text" id="itemCondition" placeholder="è¯·æè¿°ç‰©å“çš„æ–°æ—§ç¨‹åº¦å’Œä½¿ç”¨çŠ¶å†µï¼Œä¾‹å¦‚ï¼šä¹æˆæ–°ï¼Œæ— åˆ’ç—•" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; font-size: 16px; margin-bottom: 20px; transition: all 0.3s ease;">
                
                <h3 style="margin-bottom: 16px; color: var(--text-dark); font-size: 18px; font-weight: 600;">ä»·æ ¼ï¼ˆå…ƒï¼‰</h3>
                <input type="number" id="itemPrice" placeholder="ä¾‹å¦‚ 20" min="0" step="1" required style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; font-size: 16px; margin-bottom: 20px; transition: all 0.3s ease;">
                
                <!-- é¢„ä¼°å¥–åŠ± -->
                <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 16px; padding: 20px; margin: 20px 0; box-shadow: 0 4px 16px rgba(76, 175, 80, 0.1); border: 1px solid #bbf7d0;">
                    <h3 style="margin-bottom: 12px; color: var(--text-dark); font-size: 18px; font-weight: 600;">é¢„ä¼°å¥–åŠ±</h3>
                    <div style="font-size: 24px; font-weight: 700; color: #22c55e; text-shadow: 0 2px 4px rgba(34, 197, 94, 0.2);">é¢„è®¡å¯å¾—ç§¯åˆ† 10</div>
                    <div style="font-size: 14px; color: #666; margin-top: 4px;">æ¯å‘å¸ƒä¸€ä»¶é—²ç½®ç‰©å“ï¼Œä¸ºåœ°çƒå‡å°‘ç¢³æ’æ”¾</div>
                </div>
                
                <!-- ç«‹å³å‘å¸ƒæŒ‰é’® -->
                <button class="btn" onclick="submitForm()" style="margin-top: 8px;">ç«‹å³å‘å¸ƒ</button>
                
                <p style="text-align: center; font-size: 14px; color: #64748b; margin-top: 16px; line-height: 1.4;">å‘å¸ƒå³ä»£è¡¨æ‚¨åŒæ„æˆ‘ä»¬çš„<a href="#" onclick="alert('ç¤¾åŒºå‡†åˆ™å†…å®¹ï¼ˆæš‚ç•¥ï¼‰'); return false;" style="color: #22c55e; text-decoration: none; font-weight: 500;">ç¤¾åŒºå‡†åˆ™</a></p>
            </div>
        </div>
        
        <!-- æœªç™»å½•çŠ¶æ€å†…å®¹ -->
        <div id="publishLoginPrompt" style="text-align: center; padding: 80px 30px; background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 253, 244, 0.95)); border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5);">
            <span style="font-size: 80px; display: block; margin-bottom: 32px; animation: float 3s ease-in-out infinite;">ğŸ“¦</span>
            <h3 style="font-size: 24px; font-weight: 600; color: var(--text-dark); margin-bottom: 16px;">å‘å¸ƒç»¿è‰²é—²ç½®</h3>
            <p style="font-size: 16px; color: #64748b; margin-bottom: 40px; line-height: 1.5; max-width: 280px; margin-left: auto; margin-right: auto;">ç™»å½•åå³å¯å‘å¸ƒæ‚¨çš„é—²ç½®ç‰©å“ï¼Œä¸ºåœ°çƒå‡ç¢³ï¼Œè·å¾—ç»¿åˆ†å¥–åŠ±</p>
            <button style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: none; border-radius: 16px; padding: 18px 40px; font-size: 18px; font-weight: 600; cursor: pointer; min-height: 56px; min-width: 160px; box-shadow: 0 4px 20px rgba(34, 197, 94, 0.3); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); letter-spacing: 0.02em;" onclick="window.location.href='login.html'">å»ç™»å½•</button>
            <p style="font-size: 14px; color: #94a3b8; margin-top: 24px;">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="register.html" style="color: #22c55e; text-decoration: none; font-weight: 500;">ç«‹å³æ³¨å†Œ</a></p>
        </div>
        
        <script>
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            function checkLoginStatus() {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                const publishForm = document.getElementById('publishForm');
                const publishLoginPrompt = document.getElementById('publishLoginPrompt');
                
                if (isLoggedIn) {
                    publishForm.style.display = 'block';
                    publishLoginPrompt.style.display = 'none';
                } else {
                    publishForm.style.display = 'none';
                    publishLoginPrompt.style.display = 'block';
                }
            }
            
            // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
            window.onload = checkLoginStatus;
        </script>
    </div>
    
    <script src="js/auth.js"></script>
    <script src="js/script.js"></script>
    <script>
        // é¢„è§ˆä¸Šä¼ çš„å›¾ç‰‡
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                const photoPreview = document.getElementById('photoPreview');
                const previewContent = photoPreview.querySelector('.preview-content');
                
                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                photoPreview.classList.add('loading');
                const loadingSpinner = document.createElement('div');
                loadingSpinner.className = 'loading-spinner';
                photoPreview.appendChild(loadingSpinner);
                
                reader.onload = function(e) {
                    // ç§»é™¤åŠ è½½åŠ¨ç”»
                    setTimeout(() => {
                        photoPreview.classList.remove('loading');
                        if (loadingSpinner) {
                            loadingSpinner.remove();
                        }
                        
                        // åˆ›å»ºä¸“é—¨æ”¾å›¾ç‰‡çš„å®¹å™¨
                        let imageContainer = previewContent.querySelector('.image-container');
                        if (!imageContainer) {
                            imageContainer = document.createElement('div');
                            imageContainer.className = 'image-container';
                            previewContent.appendChild(imageContainer);
                        }
                        
                        // æ¸…ç©ºå›¾ç‰‡å®¹å™¨
                        imageContainer.innerHTML = '';
                        
                        // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = 'ç‰©å“ç…§ç‰‡';
                        
                        // åˆ›å»ºåˆ é™¤æŒ‰é’®
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.innerHTML = 'Ã—';
                        deleteBtn.onclick = function() {
                            // é‡ç½®æ–‡ä»¶è¾“å…¥
                            input.value = '';
                            
                            // æ›´æ–°æ–‡ä»¶åæ˜¾ç¤º
                            document.getElementById('fileName').textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                            
                            // æ¸…ç©ºå›¾ç‰‡å®¹å™¨
                            imageContainer.innerHTML = '';
                            
                            // ç§»é™¤ has-image ç±»
                            photoPreview.classList.remove('has-image');
                        };
                        
                        // æ·»åŠ åˆ°å›¾ç‰‡å®¹å™¨
                        imageContainer.appendChild(img);
                        imageContainer.appendChild(deleteBtn);
                        
                        // æ·»åŠ  has-image ç±»
                        photoPreview.classList.add('has-image');
                    }, 800); // æ¨¡æ‹ŸåŠ è½½æ—¶é—´
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // æ·»åŠ æ–‡ä»¶åæ˜¾ç¤ºé€»è¾‘å’Œæ‹–æ‹½åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('imageUpload');
            const fileNameSpan = document.getElementById('fileName');
            const photoPreview = document.getElementById('photoPreview');
            
            if (fileInput && fileNameSpan) {
                fileInput.addEventListener('change', function(e) {
                    fileNameSpan.textContent = e.target.files[0]?.name || 'æœªé€‰æ‹©æ–‡ä»¶';
                    if (e.target.files && e.target.files[0]) {
                        previewImage(this);
                    }
                });
            }
            
            if (photoPreview && fileInput) {
                // ç‚¹å‡»é¢„è§ˆåŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
                photoPreview.addEventListener('click', function(e) {
                    if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'IMG') {
                        fileInput.click();
                    }
                });
                
                // æ‹–æ‹½è¿›å…¥
                photoPreview.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.add('dragover');
                });
                
                // æ‹–æ‹½ç¦»å¼€
                photoPreview.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('dragover');
                });
                
                // æ‹–æ‹½æ”¾ä¸‹
                photoPreview.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('dragover');
                    
                    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                        fileInput.files = e.dataTransfer.files;
                        // æ›´æ–°æ–‡ä»¶åæ˜¾ç¤º
                        document.getElementById('fileName').textContent = e.dataTransfer.files[0].name;
                        previewImage(fileInput);
                    }
                });
            }
            
            // è¡¨å•å®æ—¶éªŒè¯
            const itemNameInput = document.getElementById('itemName');
            const itemCategorySelect = document.getElementById('itemCategory');
            const radioOptions = document.querySelectorAll('.radio-option');
            
            // ç‰©å“åç§°éªŒè¯
            if (itemNameInput) {
                itemNameInput.addEventListener('blur', function() {
                    const errorId = 'itemNameError';
                    if (!this.value.trim()) {
                        showError(this, errorId, 'ç‰©å“åç§°ä¸èƒ½ä¸ºç©º');
                    } else {
                        hideError(errorId);
                    }
                });
            }
            
            // ç±»åˆ«é€‰æ‹©éªŒè¯
            if (itemCategorySelect) {
                itemCategorySelect.addEventListener('change', function() {
                    const errorId = 'itemCategoryError';
                    if (!this.value) {
                        showError(this, errorId, 'è¯·é€‰æ‹©ç±»åˆ«');
                    } else {
                        hideError(errorId);
                    }
                });
            }
            
            // æ–°æ—§ç¨‹åº¦é€‰æ‹©
            radioOptions.forEach(option => {
                option.addEventListener('click', function() {
                    radioOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        });
        
        // æ˜¾ç¤ºé”™è¯¯æç¤º
        function showError(element, errorId, message) {
            hideError(errorId);
            const errorElement = document.createElement('div');
            errorElement.id = errorId;
            errorElement.className = 'error-message';
            errorElement.textContent = message;
            element.parentNode.insertBefore(errorElement, element.nextSibling);
        }
        
        // éšè—é”™è¯¯æç¤º
        function hideError(errorId) {
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.remove();
            }
        }
        
        // æ·»åŠ æŒ‰é’®åŠ è½½å’ŒæˆåŠŸçŠ¶æ€æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            .btn-loading {
                position: relative;
                pointer-events: none;
            }
            
            .btn-loading::after {
                content: '';
                position: absolute;
                top: 50%;
                right: 16px;
                width: 16px;
                height: 16px;
                margin-top: -8px;
                border: 2px solid rgba(255, 255, 255, 0.5);
                border-top: 2px solid white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            .btn-success {
                background-color: #22c55e !important;
                position: relative;
            }
            
            .btn-success::after {
                content: 'âœ“';
                position: absolute;
                top: 50%;
                right: 16px;
                transform: translateY(-50%);
                font-size: 16px;
                font-weight: bold;
            }
        `;
        document.head.appendChild(style);
        
        // å¢å¼ºç¬¬ä¸€ä¸ª submitForm å‡½æ•°
        async function submitForm() {
            console.log('submitForm å‡½æ•°å¼€å§‹æ‰§è¡Œ');
            console.log('DOM åŠ è½½çŠ¶æ€:', document.readyState);
            
            const itemName = document.getElementById('itemName')?.value;
            const itemCategory = document.getElementById('itemCategory')?.value;
            const itemCondition = document.getElementById('itemCondition')?.value;
            const itemPrice = parseFloat(document.getElementById('itemPrice')?.value) || 0;
            
            // è·å–æ–‡ä»¶è¾“å…¥æ¡†
            const fileInput = document.getElementById('imageUpload');
            console.log('è·å– fileInput:', fileInput);
            console.log('fileInput æ˜¯å¦å­˜åœ¨äº DOM ä¸­:', fileInput && document.body.contains(fileInput));
            
            const submitBtn = document.querySelector('.btn');
            console.log('è·å– submitBtn:', submitBtn);
            
            if (!fileInput || !document.body.contains(fileInput)) {
                console.warn('æœªæ‰¾åˆ°æ–‡ä»¶ä¸Šä¼ æ§ä»¶æˆ–æ§ä»¶ä¸åœ¨ DOM ä¸­ï¼Œå°†è§†ä¸ºæœªé€‰æ‹©å›¾ç‰‡');
            }
            
            // è¡¨å•éªŒè¯
            if (!itemName || !itemName.trim()) {
                showToast('è¯·è¾“å…¥ç‰©å“åç§°', 'error');
                document.getElementById('itemName').focus();
                return;
            }
            
            if (!itemCategory) {
                showToast('è¯·é€‰æ‹©ç±»åˆ«', 'error');
                document.getElementById('itemCategory').focus();
                return;
            }
            
            if (!itemCondition || !itemCondition.trim()) {
                showToast('è¯·æè¿°ç‰©å“çŠ¶å†µ', 'error');
                document.getElementById('itemCondition').focus();
                return;
            }
            
            if (!itemPrice || itemPrice <= 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼', 'error');
                document.getElementById('itemPrice').focus();
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (submitBtn) {
                submitBtn.textContent = 'å‘å¸ƒä¸­...';
                submitBtn.disabled = true;
                submitBtn.classList.add('btn-loading');
            }
            
            try {
                // è·å–ç”¨æˆ·ä¿¡æ¯
                const username = localStorage.getItem('currentUsername');
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                
                if (!isLoggedIn || !username) {
                    showToast('è¯·å…ˆç™»å½•', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1500);
                    return;
                }
                
                // ----- å›¾ç‰‡ä¸Šä¼ å¼€å§‹ -----
                let imageUrl = null;
                
                if (fileInput && fileInput.files && fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°
                    if (file.size > 5 * 1024 * 1024) {
                        showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB', 'error');
                        if (submitBtn) {
                            submitBtn.textContent = 'ç«‹å³å‘å¸ƒ';
                            submitBtn.disabled = false;
                            submitBtn.classList.remove('btn-loading');
                        }
                        return;
                    }
                    
                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                    if (!validTypes.includes(file.type)) {
                        showToast('åªæ”¯æŒ JPGã€PNGã€GIF å’Œ WebP æ ¼å¼çš„å›¾ç‰‡', 'error');
                        if (submitBtn) {
                            submitBtn.textContent = 'ç«‹å³å‘å¸ƒ';
                            submitBtn.disabled = false;
                            submitBtn.classList.remove('btn-loading');
                        }
                        return;
                    }
                    
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}_${Math.random().toString(36).substring(2)}.${fileExt}`;
                    
                    // æ­¥éª¤ Bï¼šä¸Šä¼ åˆ° item-images å­˜å‚¨æ¡¶
                    const { error: uploadError } = await supabaseClient
                        .storage
                        .from('item-images')
                        .upload(fileName, file);

                    if (uploadError) {
                        console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥', uploadError);
                        throw new Error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                    
                    // æ­¥éª¤ Cï¼šè·å–å®Œæ•´çš„å…¬å…± URL
                    const { data: publicUrlData } = supabaseClient
                        .storage
                        .from('item-images')
                        .getPublicUrl(fileName);
                    
                    imageUrl = publicUrlData.publicUrl;
                    console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œå®Œæ•´ URL:', imageUrl);
                } else {
                    console.log('æœªé€‰æ‹©å›¾ç‰‡ï¼Œimage_url å°†ä¸º null');
                }
                // ----- å›¾ç‰‡ä¸Šä¼ ç»“æŸ -----
                
                // å‡†å¤‡æäº¤æ•°æ®
                const itemData = {
                    name: itemName.trim(),
                    category: itemCategory,
                    condition: itemCondition.trim(),
                    price: itemPrice,
                    seller: username,
                    image_url: imageUrl,
                    created_at: new Date().toISOString()
                };
                
                console.log('å‡†å¤‡æ’å…¥æ•°æ®åº“çš„æ•°æ®:', itemData);
                
                // æ­¥éª¤ Dï¼šæ’å…¥æ•°æ®åº“
                const { data, error } = await supabaseClient
                    .from('used_items')
                    .insert([itemData]);
                
                if (error) {
                    console.error('æäº¤å¤±è´¥:', error);
                    throw new Error('å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
                
                // å¢åŠ ç”¨æˆ·ç§¯åˆ†
                let pointsAdded = false;
                try {
                    const { data: profileData, error: profileError } = await supabaseClient
                        .from('profiles')
                        .select('id')
                        .eq('username', username)
                        .single();
                    
                    if (profileError) {
                        console.error('è·å–ç”¨æˆ·IDå¤±è´¥:', profileError);
                    } else {
                        // ä½¿ç”¨ parseInt() æ˜¾å¼å°† profileData.id è½¬æ¢ä¸ºæ•´æ•°ç±»å‹
                        const userId = parseInt(profileData?.id);
                        
                        // ç¡®ä¿è°ƒç”¨ supabaseClient.rpc('handle_add_points', ...) æ—¶ä¼ é€’çš„æ˜¯è½¬æ¢åçš„æ•´æ•° userId
                        const { error: rpcError } = await supabaseClient.rpc('handle_add_points', { 
                            user_id: userId, 
                            amount: 10 
                        });
                        
                        if (rpcError) {
                            console.error('RPC è°ƒç”¨å¤±è´¥:', rpcError);
                        } else {
                            // æ›´æ–° localStorage ä¸­çš„ userPoints
                            const { data: newProfileData } = await supabaseClient
                                .from('profiles')
                                .select('points')
                                .eq('username', username)
                                .single();
                            
                            if (newProfileData) {
                                localStorage.setItem('userPoints', newProfileData.points);
                                console.log('ç§¯åˆ†æ›´æ–°æˆåŠŸï¼Œå½“å‰ç§¯åˆ†:', newProfileData.points);
                                pointsAdded = true;
                            }
                        }
                    }
                } catch (pointsError) {
                    console.error('ç§¯åˆ†æ›´æ–°å¼‚å¸¸:', pointsError);
                }
                
                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                if (submitBtn) {
                    submitBtn.textContent = 'å‘å¸ƒæˆåŠŸï¼';
                    submitBtn.classList.remove('btn-loading');
                    submitBtn.classList.add('btn-success');
                }
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                if (pointsAdded) {
                    showToast('å‘å¸ƒæˆåŠŸï¼è·å¾— 10 ç»¿åˆ†å¥–åŠ±ï¼', 'success');
                } else {
                    showToast('å‘å¸ƒæˆåŠŸï¼', 'success');
                }
                
                // å»¶è¿Ÿåé‡ç½®è¡¨å•
                setTimeout(() => {
                    if (submitBtn) {
                        submitBtn.textContent = 'ç«‹å³å‘å¸ƒ';
                        submitBtn.classList.remove('btn-success');
                        submitBtn.disabled = false;
                    }
                    
                    // é‡ç½®è¡¨å•
                    const form = document.getElementById('publishForm');
                    if (form) {
                        form.reset();
                    }
                    
                    // é‡ç½®é¢„è§ˆåŒºåŸŸ
                    const photoPreview = document.getElementById('photoPreview');
                    if (photoPreview) {
                        const previewContent = photoPreview.querySelector('.preview-content');
                        if (previewContent) {
                            previewContent.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="upload-icon"><path d="M16 16v1a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-1"></path><path d="M8 16s-4-4-4-8a4 4 0 0 1 8 0c0 4-4 8-4 8"></path><path d="M12 12v6"></path><path d="m15 15-3-3-3 3"></path></svg>
                                <h3>æ·»åŠ ç…§ç‰‡</h3>
                                <p style="color: #666; font-size: 14px; margin: 8px 0 16px;">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡è‡³æ­¤</p>
                                <p style="color: #999; font-size: 12px; margin-bottom: 24px;">ä¸Šä¼ ä¸€å¼ æ¸…æ™°çš„ç‰©å“ç…§ç‰‡</p>
                                <button class="upload-btn" onclick="event.stopPropagation(); document.getElementById('imageUpload').click()">é€‰æ‹©å›¾ç‰‡</button>
                            `;
                        }
                        photoPreview.classList.remove('has-image');
                        document.getElementById('fileName').textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                        if (fileInput) {
                            fileInput.value = '';
                        }
                    }
                }, 3000);
                
            } catch (error) {
                console.error('æäº¤å¼‚å¸¸:', error);
                showToast(error.message || 'å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (submitBtn) {
                    submitBtn.textContent = 'ç«‹å³å‘å¸ƒ';
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('btn-loading');
                }
            }
        }
        
        // æ·»åŠ  Toast é€šçŸ¥å‡½æ•°
        function showToast(message, type = 'info') {
            // åˆ›å»º Toast å®¹å™¨
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    z-index: 9999;
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    pointer-events: none;
                `;
                document.body.appendChild(toastContainer);
            }
            
            // åˆ›å»º Toast å…ƒç´ 
            const toast = document.createElement('div');
            toast.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 16px 20px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 14px;
                font-weight: 500;
                pointer-events: auto;
                animation: toast-in 0.3s ease forwards;
                max-width: 320px;
                border-left: 4px solid #22c55e;
            `;
            
            // è®¾ç½®ä¸åŒç±»å‹çš„æ ·å¼
            if (type === 'error') {
                toast.style.borderLeftColor = '#ef4444';
            } else if (type === 'success') {
                toast.style.borderLeftColor = '#22c55e';
            } else if (type === 'warning') {
                toast.style.borderLeftColor = '#f59e0b';
            }
            
            // æ·»åŠ å›¾æ ‡
            let icon = 'â„¹ï¸';
            if (type === 'error') {
                icon = 'âŒ';
            } else if (type === 'success') {
                icon = 'âœ…';
            } else if (type === 'warning') {
                icon = 'âš ï¸';
            }
            
            toast.innerHTML = `
                <span style="font-size: 18px;">${icon}</span>
                <span>${message}</span>
            `;
            
            // æ·»åŠ åˆ°å®¹å™¨
            toastContainer.appendChild(toast);
            
            // 3ç§’åç§»é™¤
            setTimeout(() => {
                toast.style.animation = 'toast-out 0.3s ease forwards';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // æ·»åŠ  Toast åŠ¨ç”»
        const toastStyle = document.createElement('style');
        toastStyle.textContent = `
            @keyframes toast-in {
                from {
                    opacity: 0;
                    transform: translateY(-20px) scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }
            @keyframes toast-out {
                from {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
                to {
                    opacity: 0;
                    transform: translateY(-20px) scale(0.95);
                }
            }
        `;
        document.head.appendChild(toastStyle);
    </script>
    <script src="js/footer.js"></script>
</body>
</html>