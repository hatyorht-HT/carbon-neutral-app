<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta name="description" content="å‘å¸ƒç»¿è‰²é—²ç½®ï¼Œä¸ºåœ°çƒå‡ç¢³ï¼Œè·å¾—ç»¿åˆ†å¥–åŠ±ã€‚">
    <title>å‘å¸ƒé—²ç½® - ç¢³ä¸­å’Œæ ¡å›­</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabaseClient.js"></script>
    <style>
        .photo-upload {
            margin-bottom: 24px;
        }
        
        .photo-preview {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            backdrop-filter: blur(10px);
            border: 2px dashed #4caf50;
            border-radius: 16px;
            padding: 48px 16px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .photo-preview.dragover {
            border-color: #2e7d32;
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.2);
        }
        
        .photo-preview.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid rgba(76, 175, 80, 0.2);
            border-top: 4px solid #4caf50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .photo-preview:hover {
            border-color: #2e7d32;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);
        }
        
        .preview-content {
            position: relative;
        }
        
        .image-container {
            position: relative;
            display: inline-block;
        }
        
        .upload-icon {
            color: #4caf50;
            margin-bottom: 16px;
        }
        
        .photo-preview.has-image {
            border-style: solid;
            padding: 16px;
        }
        
        .photo-preview.has-image .image-container {
            position: relative;
            display: inline-block;
        }
        
        .photo-preview.has-image img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.2s ease;
        }
        
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        
        .upload-btn {
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        
        .upload-btn:hover {
            background-color: #2e7d32;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å‘å¸ƒç»¿è‰²é—²ç½®</h1>
        
        <!-- é¡µé¢å‰¯æ ‡é¢˜ -->
        <div class="card" style="background-color: #f0fdf4; margin-bottom: 24px;">
            <h3>ä¸Šä¼ ä½ çš„é—²ç½®ï¼ŒåŠ©åŠ›ç¢³å‡æ’</h3>
            <p style="color: #666; font-size: 14px; margin-top: 8px;">ä½ çš„æ¯ä¸€æ¬¡å›æ”¶éƒ½åœ¨å®ˆæŠ¤åœ°çƒã€‚</p>
        </div>
        
        <!-- å·²ç™»å½•çŠ¶æ€å†…å®¹ -->
        <div id="publishForm" style="display: none;">
            <!-- æ·»åŠ ç…§ç‰‡åŒºåŸŸ -->
            <div class="photo-upload">
                <div id="photoPreview" class="photo-preview">
                    <div class="preview-content">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="upload-icon"><path d="M16 16v1a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-1"></path><path d="M8 16s-4-4-4-8a4 4 0 0 1 8 0c0 4-4 8-4 8"></path><path d="M12 12v6"></path><path d="m15 15-3-3-3 3"></path></svg>
                        <h3>æ·»åŠ ç…§ç‰‡</h3>
                        <p style="color: #666; font-size: 14px; margin: 8px 0 16px;">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡è‡³æ­¤</p>
                        <p style="color: #999; font-size: 12px; margin-bottom: 24px;">ä¸Šä¼ ä¸€å¼ æ¸…æ™°çš„ç‰©å“ç…§ç‰‡</p>
                        <button class="upload-btn" onclick="event.stopPropagation(); document.getElementById('imageUpload').click()">é€‰æ‹©å›¾ç‰‡</button>
                    </div>
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                    <span id="fileName">æœªé€‰æ‹©æ–‡ä»¶</span>
                </div>
            </div>
            
            <!-- è¡¨å• -->
            <div class="card">
                <h3>ç‰©å“åç§°</h3>
                <input type="text" id="itemName" placeholder="ä¾‹å¦‚ï¼šä¸­å¤ç»ç’ƒç“¶">
                
                <h3>ç±»åˆ«é€‰æ‹©</h3>
                <select id="itemCategory">
                    <option value="">é€‰æ‹©ç±»åˆ«</option>
                    <option value="digital">æ•°ç </option>
                    <option value="clothing">è¡£ç‰©</option>
                    <option value="books">ä¹¦ç±</option>
                    <option value="other">å…¶ä»–</option>
                </select>
                
                <h3>äº§å“çŠ¶å†µ</h3>
                <input type="text" id="itemCondition" placeholder="è¯·æè¿°ç‰©å“çš„æ–°æ—§ç¨‹åº¦å’Œä½¿ç”¨çŠ¶å†µï¼Œä¾‹å¦‚ï¼šä¹æˆæ–°ï¼Œæ— åˆ’ç—•">
                
                <h3>ä»·æ ¼ï¼ˆå…ƒï¼‰</h3>
                <input type="number" id="itemPrice" placeholder="ä¾‹å¦‚ 20" min="0" step="1" required>
                
                <!-- é¢„ä¼°å¥–åŠ± -->
                <div style="background-color: #f0fdf4; border-radius: 8px; padding: 16px; margin: 16px 0;">
                    <h3 style="margin-bottom: 8px;">é¢„ä¼°å¥–åŠ±</h3>
                    <div style="font-size: 18px; font-weight: 700; color: #2ecc71;">é¢„è®¡å¯å¾—ç§¯åˆ† 10</div>
                </div>
                
                <!-- ç«‹å³å‘å¸ƒæŒ‰é’® -->
                <button class="btn" onclick="submitForm()">ç«‹å³å‘å¸ƒ</button>
                
                <p style="text-align: center; font-size: 12px; color: #999; margin-top: 12px;">å‘å¸ƒå³ä»£è¡¨æ‚¨åŒæ„æˆ‘ä»¬çš„<a href="#" onclick="alert('ç¤¾åŒºå‡†åˆ™å†…å®¹ï¼ˆæš‚ç•¥ï¼‰'); return false;">ç¤¾åŒºå‡†åˆ™</a></p>
            </div>
        </div>
        
        <!-- æœªç™»å½•çŠ¶æ€å†…å®¹ -->
        <div id="publishLoginPrompt" style="text-align: center; padding: 60px 20px; background-color: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <span style="font-size: 48px;">ğŸ“¦</span>
            <p style="font-size: 18px; margin: 20px 0;">ç™»å½•åå³å¯å‘å¸ƒç»¿è‰²é—²ç½®</p>
            <button style="background-color: #2ecc71; color: white; border: none; border-radius: 8px; padding: 14px 32px; font-size: 16px; font-weight: 500; cursor: pointer; min-height: 44px; min-width: 120px;" onclick="window.location.href='login.html'">å»ç™»å½•</button>
        </div>
        
        <script>
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            function checkLoginStatus() {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                const publishForm = document.getElementById('publishForm');
                const publishLoginPrompt = document.getElementById('publishLoginPrompt');
                
                if (isLoggedIn) {
                    publishForm.style.display = 'block';
                    publishLoginPrompt.style.display = 'none';
                } else {
                    publishForm.style.display = 'none';
                    publishLoginPrompt.style.display = 'block';
                }
            }
            
            // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
            window.onload = checkLoginStatus;
        </script>
    </div>
    
    <script src="js/auth.js"></script>
    <script src="js/script.js"></script>
    <script>
        // é¢„è§ˆä¸Šä¼ çš„å›¾ç‰‡
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                const photoPreview = document.getElementById('photoPreview');
                const previewContent = photoPreview.querySelector('.preview-content');
                
                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                photoPreview.classList.add('loading');
                const loadingSpinner = document.createElement('div');
                loadingSpinner.className = 'loading-spinner';
                photoPreview.appendChild(loadingSpinner);
                
                reader.onload = function(e) {
                    // ç§»é™¤åŠ è½½åŠ¨ç”»
                    setTimeout(() => {
                        photoPreview.classList.remove('loading');
                        if (loadingSpinner) {
                            loadingSpinner.remove();
                        }
                        
                        // åˆ›å»ºä¸“é—¨æ”¾å›¾ç‰‡çš„å®¹å™¨
                        let imageContainer = previewContent.querySelector('.image-container');
                        if (!imageContainer) {
                            imageContainer = document.createElement('div');
                            imageContainer.className = 'image-container';
                            previewContent.appendChild(imageContainer);
                        }
                        
                        // æ¸…ç©ºå›¾ç‰‡å®¹å™¨
                        imageContainer.innerHTML = '';
                        
                        // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = 'ç‰©å“ç…§ç‰‡';
                        
                        // åˆ›å»ºåˆ é™¤æŒ‰é’®
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.innerHTML = 'Ã—';
                        deleteBtn.onclick = function() {
                            // é‡ç½®æ–‡ä»¶è¾“å…¥
                            input.value = '';
                            
                            // æ›´æ–°æ–‡ä»¶åæ˜¾ç¤º
                            document.getElementById('fileName').textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                            
                            // æ¸…ç©ºå›¾ç‰‡å®¹å™¨
                            imageContainer.innerHTML = '';
                            
                            // ç§»é™¤ has-image ç±»
                            photoPreview.classList.remove('has-image');
                        };
                        
                        // æ·»åŠ åˆ°å›¾ç‰‡å®¹å™¨
                        imageContainer.appendChild(img);
                        imageContainer.appendChild(deleteBtn);
                        
                        // æ·»åŠ  has-image ç±»
                        photoPreview.classList.add('has-image');
                    }, 800); // æ¨¡æ‹ŸåŠ è½½æ—¶é—´
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // æ·»åŠ æ–‡ä»¶åæ˜¾ç¤ºé€»è¾‘å’Œæ‹–æ‹½åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('imageUpload');
            const fileNameSpan = document.getElementById('fileName');
            const photoPreview = document.getElementById('photoPreview');
            
            if (fileInput && fileNameSpan) {
                fileInput.addEventListener('change', function(e) {
                    fileNameSpan.textContent = e.target.files[0]?.name || 'æœªé€‰æ‹©æ–‡ä»¶';
                    if (e.target.files && e.target.files[0]) {
                        previewImage(this);
                    }
                });
            }
            
            if (photoPreview && fileInput) {
                // ç‚¹å‡»é¢„è§ˆåŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
                photoPreview.addEventListener('click', function(e) {
                    if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'IMG') {
                        fileInput.click();
                    }
                });
                
                // æ‹–æ‹½è¿›å…¥
                photoPreview.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.add('dragover');
                });
                
                // æ‹–æ‹½ç¦»å¼€
                photoPreview.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('dragover');
                });
                
                // æ‹–æ‹½æ”¾ä¸‹
                photoPreview.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('dragover');
                    
                    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                        fileInput.files = e.dataTransfer.files;
                        // æ›´æ–°æ–‡ä»¶åæ˜¾ç¤º
                        document.getElementById('fileName').textContent = e.dataTransfer.files[0].name;
                        previewImage(fileInput);
                    }
                });
            }
            
            // è¡¨å•å®æ—¶éªŒè¯
            const itemNameInput = document.getElementById('itemName');
            const itemCategorySelect = document.getElementById('itemCategory');
            const radioOptions = document.querySelectorAll('.radio-option');
            
            // ç‰©å“åç§°éªŒè¯
            if (itemNameInput) {
                itemNameInput.addEventListener('blur', function() {
                    const errorId = 'itemNameError';
                    if (!this.value.trim()) {
                        showError(this, errorId, 'ç‰©å“åç§°ä¸èƒ½ä¸ºç©º');
                    } else {
                        hideError(errorId);
                    }
                });
            }
            
            // ç±»åˆ«é€‰æ‹©éªŒè¯
            if (itemCategorySelect) {
                itemCategorySelect.addEventListener('change', function() {
                    const errorId = 'itemCategoryError';
                    if (!this.value) {
                        showError(this, errorId, 'è¯·é€‰æ‹©ç±»åˆ«');
                    } else {
                        hideError(errorId);
                    }
                });
            }
            
            // æ–°æ—§ç¨‹åº¦é€‰æ‹©
            radioOptions.forEach(option => {
                option.addEventListener('click', function() {
                    radioOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        });
        
        // æ˜¾ç¤ºé”™è¯¯æç¤º
        function showError(element, errorId, message) {
            hideError(errorId);
            const errorElement = document.createElement('div');
            errorElement.id = errorId;
            errorElement.className = 'error-message';
            errorElement.textContent = message;
            element.parentNode.insertBefore(errorElement, element.nextSibling);
        }
        
        // éšè—é”™è¯¯æç¤º
        function hideError(errorId) {
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.remove();
            }
        }
        
        // æ·»åŠ æŒ‰é’®åŠ è½½å’ŒæˆåŠŸçŠ¶æ€æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            .btn-loading {
                position: relative;
                pointer-events: none;
            }
            
            .btn-loading::after {
                content: '';
                position: absolute;
                top: 50%;
                right: 16px;
                width: 16px;
                height: 16px;
                margin-top: -8px;
                border: 2px solid rgba(255, 255, 255, 0.5);
                border-top: 2px solid white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            .btn-success {
                background-color: #22c55e !important;
                position: relative;
            }
            
            .btn-success::after {
                content: 'âœ“';
                position: absolute;
                top: 50%;
                right: 16px;
                transform: translateY(-50%);
                font-size: 16px;
                font-weight: bold;
            }
        `;
        document.head.appendChild(style);
        
        // å¢å¼ºç¬¬ä¸€ä¸ª submitForm å‡½æ•°
        async function submitForm() {
            console.log('submitForm å‡½æ•°å¼€å§‹æ‰§è¡Œ');
            console.log('DOM åŠ è½½çŠ¶æ€:', document.readyState);
            
            const itemName = document.getElementById('itemName')?.value;
            const itemCategory = document.getElementById('itemCategory')?.value;
            const itemCondition = document.getElementById('itemCondition')?.value;
            const itemPrice = parseFloat(document.getElementById('itemPrice')?.value) || 0;
            
            // è·å–æ–‡ä»¶è¾“å…¥æ¡†
            const fileInput = document.getElementById('imageUpload');
            console.log('è·å– fileInput:', fileInput);
            console.log('fileInput æ˜¯å¦å­˜åœ¨äº DOM ä¸­:', fileInput && document.body.contains(fileInput));
            
            const submitBtn = document.querySelector('.btn');
            console.log('è·å– submitBtn:', submitBtn);
            
            if (!fileInput || !document.body.contains(fileInput)) {
                console.warn('æœªæ‰¾åˆ°æ–‡ä»¶ä¸Šä¼ æ§ä»¶æˆ–æ§ä»¶ä¸åœ¨ DOM ä¸­ï¼Œå°†è§†ä¸ºæœªé€‰æ‹©å›¾ç‰‡');
            }
            
            if (!itemName) {
                alert('è¯·è¾“å…¥ç‰©å“åç§°');
                return;
            }
            
            if (!itemCategory) {
                alert('è¯·é€‰æ‹©ç±»åˆ«');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (submitBtn) {
                submitBtn.textContent = 'å‘å¸ƒä¸­...';
                submitBtn.disabled = true;
                submitBtn.classList.add('btn-loading');
            }
            
            try {
                // è·å–ç”¨æˆ·ä¿¡æ¯
                const username = localStorage.getItem('currentUsername');
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                
                if (!isLoggedIn || !username) {
                    alert('è¯·å…ˆç™»å½•');
                    if (submitBtn) {
                        submitBtn.textContent = 'ç«‹å³å‘å¸ƒ';
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('btn-loading');
                    }
                    return;
                }
                
                // ----- å›¾ç‰‡ä¸Šä¼ å¼€å§‹ -----
                let imageUrl = null;
                
                if (fileInput && fileInput.files && fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}_${Math.random().toString(36).substring(2)}.${fileExt}`;
                    
                    // æ­¥éª¤ Bï¼šä¸Šä¼ åˆ° item-images å­˜å‚¨æ¡¶
                    const { error: uploadError } = await supabaseClient
                        .storage
                        .from('item-images')
                        .upload(fileName, file);

                    if (uploadError) {
                        console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥', uploadError);
                        throw new Error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                    
                    // æ­¥éª¤ Cï¼šè·å–å®Œæ•´çš„å…¬å…± URL
                    const { data: publicUrlData } = supabaseClient
                        .storage
                        .from('item-images')
                        .getPublicUrl(fileName);
                    
                    imageUrl = publicUrlData.publicUrl;
                    console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œå®Œæ•´ URL:', imageUrl);
                } else {
                    console.log('æœªé€‰æ‹©å›¾ç‰‡ï¼Œimage_url å°†ä¸º null');
                }
                // ----- å›¾ç‰‡ä¸Šä¼ ç»“æŸ -----
                
                // å‡†å¤‡æäº¤æ•°æ®
                const itemData = {
                    name: itemName,
                    category: itemCategory,
                    condition: itemCondition,
                    price: itemPrice,
                    seller: username,
                    image_url: imageUrl,
                    created_at: new Date().toISOString()
                };
                
                console.log('å‡†å¤‡æ’å…¥æ•°æ®åº“çš„æ•°æ®:', itemData);
                
                // æ­¥éª¤ Dï¼šæ’å…¥æ•°æ®åº“
                const { data, error } = await supabaseClient
                    .from('used_items')
                    .insert([itemData]);
                
                if (error) {
                    console.error('æäº¤å¤±è´¥:', error);
                    alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    if (submitBtn) {
                        submitBtn.textContent = 'ç«‹å³å‘å¸ƒ';
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('btn-loading');
                    }
                    return;
                }
                
                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                if (submitBtn) {
                    submitBtn.textContent = 'å‘å¸ƒæˆåŠŸï¼';
                    submitBtn.classList.remove('btn-loading');
                    submitBtn.classList.add('btn-success');
                }
                
                // å»¶è¿Ÿåè·³è½¬åˆ°é¦–é¡µ
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
                
            } catch (error) {
                console.error('æäº¤å¼‚å¸¸:', error);
                alert(error.message || 'å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (submitBtn) {
                    submitBtn.textContent = 'ç«‹å³å‘å¸ƒ';
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('btn-loading');
                }
            }
        }
    </script>
    <script src="js/footer.js"></script>
</body>
</html>